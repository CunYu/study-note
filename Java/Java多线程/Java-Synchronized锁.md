### 概述

synchronized是java中常用同步的方法，在之前其是一个重量级的锁，但在Java 1.6中，对锁进行了相关的优化，提高了效率，使其变得不那么重了。

### 对象头

在JVM中，对象是由对象头，实例数据，对齐补充三部分组成的。

对象头用来存储对象的元数据，实例数据存放的是对象的基本数据，对齐补充是因为JVM要求对象起始地址必须为8字节的整数倍，其是用来补位对齐的。

##### 32位对象头结构

对象头是由Mark Word（对象的基本数据），Class Metadata Address（对象类型数据的指针）和Array length（如果当前对象为数组）组成的。

* Mark Word

<table>
    <tr>
        <th rowspan = "2">锁状态</th>
        <th colspan = "2">25bit</th>
        <th rowspan = "2">4bit</th>
        <th>1bit</th>
        <th>2bit</th>
    </tr>
    <tr>
        <th>23bit</th>
        <th>2bit</th>
        <th>偏向锁标识</th>
        <th>锁标志位</th>
    </tr>
    <tr>
        <td>无锁</td>
        <td colspan = "2">对象hashCode</td>
        <td>对象分代年龄</td>
        <td>0</td>
        <td>01</td>
    </tr>
    <tr>
        <td>偏向级锁</td>
        <td>线程ID</td>
        <td>Epoch</td>
        <td>对象分代年龄</td>
        <td>1</td>
        <td>01</td>
    </tr>
    <tr>
        <td>轻量级锁</td>
        <td colspan = "4">指向栈中锁纪录的指针</td>
        <td>00</td>
    </tr>
    <tr>
        <td>重量级锁</td>
        <td colspan = "4">指向Monitor的指针</td>
        <td>10</td>
    </tr>
    <tr>
        <td>GC标记</td>
        <td colspan = "4"></td>
        <td>11</td>
    </tr>
</table>

### 锁

Java1.6中，为了提高性能，将synchronized锁划分为三个，偏向锁，轻量级锁，重量级锁，偏向锁和轻量级锁是通过操作synchronized对象的对象头实现的，重量级锁需要使用monitor对象。

偏向锁会升级为轻量级锁，轻量级锁会升级为重量级锁，锁只能升级，不能降级。

##### 偏向锁

偏向锁适用于只有一个线程使用的情况。

* 获取锁

当线程第一次获取偏向锁时，会修改synchronized对象对象头中的Mark Word，并将线程ID存入其中。

当线程再次获取偏向锁时，会判断synchronized对象对象头中的Mark Word是否存储的时当前线程ID，如果是，则获取到了锁，如果不是，判断一下偏向锁标识，如果标识符为1，则表示当前是偏向锁，其会通过CAS方式竞争锁，如果标识符为0，则将标识符更改为1，并将当前线程ID存入对象头的Mark Word中。

* 释放锁

当通过CAS方式竞争锁时，当前获取偏向锁的线程会释放偏向锁，其会在安全点或安全区域暂停当前获取到偏向锁的线程，如果该线程存活，则判断需要同步的代码块是否已执行完毕，如果执行完毕，则将对synchronized对象对象头中的Mark Word中的线程ID替换为其他线程，如果没有执行完毕则升级锁，然后唤醒被暂停的线程，如果该线程不存活，那么将该对象设置为无锁状态。

##### 轻量级锁

轻量级锁适用于多个线程交替使用的情况。

* 获取锁

当线程执行同步代码块时，会在当前线程的栈中创建锁记录空间然后将synchronized对象对象头中的Mark Word复制到其中，然后使用CAS的方式将synchronized对象对象头中的Mark Word替换为指向该线程锁纪录的指针，如果成功，则获取锁，如失败则通过自旋的方式去获取锁。

* 释放锁

在线程释放锁时，其会通过CAS方式将指向该锁纪录的指针替换为锁记录，如成功，则释放锁，如果失败，则需要将锁升级为重量级锁。

##### 重量级锁

重量级锁适用于多个线程同时使用的情况。

其通过获取锁对象的monitor来表示获取到了锁，其作用类型于AQS，操作monitor是一个耗时的操作。